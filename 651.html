<!DOCTYPE html>
<html>
<head lang=en>
    <meta charset=UTF-8>
    <title>160x600</title>
    <style>
        div, span, h1, h2, h3, h4, h5, h6, p, pre,
        a, strong, em, sub, sup, img, b, u, i,
        form, label, input, textarea, ol, ul, li {
            margin: 0;
            padding: 0;
            border: 0;
            font-size: 100%;
            font: inherit;
            vertical-align: baseline;
        }

        body {
            line-height: 1;
            margin: 0;
            padding: 0;
        }

        .ad_body {
            height: 600px;
            width: 160px;
            position: relative;
            {% if background_color %}
                background: {{ background_color.rgb }};
            {% else %}
                background: white;
            {% endif %}
            background: -moz-linear-gradient(top,  rgba(0,0,0,0.3) 0%, rgba(229,229,229,0.3) 100%); /* FF3.6+ */
            background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(0,0,0,0.3)), color-stop(100%,rgba(229,229,229,0.3))); /* Chrome,Safari4+ */
            background: -webkit-linear-gradient(top, rgba(0,0,0,0.3) 0%,rgba(229,229,229,0.3) 100%); /* Chrome10+,Safari5.1+ */
            background: -o-linear-gradient(top, rgba(0,0,0,0.3) 0%,rgba(229,229,229,0.3) 100%); /* Opera 11.10+ */
            background: -ms-linear-gradient(top, rgba(0,0,0,0.3) 0%,rgba(229,229,229,0.3) 100%); /* IE10+ */
            background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%,rgba(229,229,229,0.3) 100%); /* W3C */
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#4d000000', endColorstr='#4de5e5e5',GradientType=0 ); /* IE6-9 */
        }

        .ad_logo {
            width: 160px;
            height: 100px;
            text-align: center;
            display: table-cell;
            vertical-align: middle;
            background: {{logo.background_color}} url({{ logo.rel_path }}) no-repeat 50% 50%;
        }

        .ad_header p {
            margin: 9px;
            padding: 4px;
            text-align: center;
            font-size: 20px;
            font-family: "Gill Sans", "Gill Sans MT", "Myriad Pro", "DejaVu Sans Condensed", Helvetica, Arial, sans-serif;
            {% if foreground_color %}
                color: {{ foreground_color.rgb }};
            {% else %}
                color: black;
            {% endif %}
        }

        .ad_photo {
            text-align: center;
        }

        .ad_photo img {
            border: #EAEAEA solid 4px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.75);
            margin-top: 16px;
        }

        .ad_footer {
            width: 160px;
            text-align: center;
            position: absolute;
            bottom: 52px;
        }

        .action {
            border-radius: 5px;
            padding: 15px;
            font-family: "Gill Sans", "Gill Sans MT", "Myriad Pro", "DejaVu Sans Condensed", Helvetica, Arial, sans-serif;
            font-weight: bold;
            font-size: 14px;
            text-decoration: none;
            text-transform: uppercase;
            {% if call_to_action.background_color %}
                background: {{ call_to_action.background_color.rgb }};
            {% else %}
                background: red;
            {% endif %}
            {% if call_to_action.foreground_color %}
                color: {{ call_to_action.foreground_color.rgb }};
            {% else %}
                color: white;
            {% endif %}
        }
    </style>
</head>

<body>
    <div class=ad_body>
        <div class=ad_logo></div>

        <div class=ad_header>
            {% if headline %}
                <p>{{ headline.text }}</p>
            {% endif %}
            {% if description_1 %}
                <p class=desc_1>{{ description_1.text }}</p>
            {% endif %}
        </div>

        <div class=ad_photo></div>

        <div class=ad_footer>
            <a class=action href="{{ call_to_action.href }}" target=_blank>{{ call_to_action.text }}</a>
        </div>
    </div>

    <script>
        var slides = [
                {% for im in images %}
                    "{{ im.rel_path }}",
                {% endfor %}
            ];
        
        function addImages() {
            
            function generatePermutations (array) {
                var permArr = [],
                    usedChars = [];
                function recursive (array){
                    var ch;
                    for (var i = 0, len = array.length; i < len; i++) {
                        ch = array.splice(i, 1)[0];
                        usedChars.push(ch);
                        if (len === 1) {
                            permArr.push(usedChars.slice());
                        }
                        else {
                            recursive(array);
                        }
                        array.splice(i, 0, ch);
                        usedChars.pop();
                    }
                    return permArr;
                }
                return recursive(array);
            }
            
            function findMaxPermutation (array) {
                var maximum = 0,
                    permutationIndex = 0,
                    imagesBelowLimit = 0,
                    permutations = generatePermutations(array);
                
                for (var i = 0, len = permutations.length; i < len; i++) {
                    var height = 0,
                        lastHeight = 0;
                    for (var j = 0; j < imagesCount; j++) {
                        height += permutations[i][j].height;
                        if (height > maxHeight) {
                            if (lastHeight > maximum) {
                                maximum = lastHeight;
                                permutationIndex = i;
                                imagesBelowLimit = j;
                            }
                            break;
                        }
                        lastHeight = height;
                    }
                }
                
                permutations[permutationIndex].splice(imagesBelowLimit);
                return permutations[permutationIndex];
            }
            
            function renderImages () {
                images = findMaxPermutation(images);
                for (var i = 0, len = images.length; i < len; i++) {
                    ad_photo.appendChild(images[i]);
                }
            }

            
            function getHeight (selector) {
                return document.querySelector(selector).offsetHeight;
            }
            
            var loaded = 0,
                images = [],
                marginTop = 16, //some hardcode here, sorry
                maxHeight = getHeight('body') - getHeight('.ad_logo') - getHeight('.ad_header') - getHeight('.ad_footer > a') - 5 * marginTop,
                ad_photo = document.querySelector('.ad_photo');
    
            // fix for ie8 last-comma bug
            if (slides[slides.length - 1] === undefined) {
                slides.pop();
            }
        
            var imagesCount = Math.min(slides.length, 3);  // HARDCODED MAX IMAGES COUNT
        
            for (var i = 0; i < imagesCount; i++) {
                var image = new Image();
                image.src = slides[i];
                image.onload = function () {
                    images.push(this);
                    if (++loaded === imagesCount) {
                        renderImages();
                    }
                };
            }
        }

 
        function adjustTextWidth (selector, maxWidth/* optional */, maxHeight/* optional */) {
            var els = document.querySelectorAll(selector),
                length = els.length;
    
            while (length--) {
                var element = els[length],
                    html = element.innerHTML;
            
                element.innerHTML = '<div style="padding:0!important; border:0!important; margin:0!important;">' + html + '</div>';
                var inner = element.children[0],
                    computed = window.getComputedStyle(inner),
                    fontSize = parseInt(computed.fontSize);
                maxWidth = maxWidth || parseFloat(computed.width);
                maxHeight = maxHeight || parseFloat(computed.height);
    
                while (inner.scrollWidth > maxWidth || inner.scrollHeight > maxHeight) {
                    fontSize--;
                    element.style.fontSize = fontSize + 'px';
                    element.style.display = 'none';
                    element.offsetHeight;   // this is an important part of the magic that forses DOM repaint
                    element.style.display = '';
                    if (!fontSize) {        // against infinite loop. reset to initial state
                        element.style.fontSize = '';
                        break;
                    }
                }
                
                element.innerHTML = html;
            }
        }

        adjustTextWidth('p');
        
        addImages();
        
    </script>

</body>
</html>